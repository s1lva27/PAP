<?php
session_start();
require "ligabd.php";

header('Content-Type: application/json');

// Verificar se o utilizador está autenticado
if (!isset($_SESSION['id'])) {
    echo json_encode(['success' => false, 'message' => 'Não autenticado']);
    exit;
}

$currentUserId = $_SESSION['id'];

// Query inteligente para sugestões
$sqlSuggestions = "
    SELECT DISTINCT u.id, u.nome_completo, u.nick, p.foto_perfil, p.ocupacao,
           COUNT(DISTINCT s2.id_seguidor) as total_seguidores,
           COUNT(DISTINCT pub.id_publicacao) as total_publicacoes,
           MAX(pub.data_criacao) as ultima_publicacao,
           CASE 
               WHEN EXISTS (
                   SELECT 1 FROM seguidores s3 
                   WHERE s3.id_seguidor IN (
                       SELECT id_seguido FROM seguidores WHERE id_seguidor = ?
                   ) AND s3.id_seguido = u.id
               ) THEN 1 ELSE 0 
           END as seguido_por_amigos
    FROM utilizadores u
    LEFT JOIN perfis p ON u.id = p.id_utilizador
    LEFT JOIN seguidores s2 ON u.id = s2.id_seguido
    LEFT JOIN publicacoes pub ON u.id = pub.id_utilizador AND pub.deletado_em = '0000-00-00 00:00:00'
    WHERE u.id != ?
    AND u.id NOT IN (
        SELECT id_seguido FROM seguidores WHERE id_seguidor = ?
    )
    GROUP BY u.id, u.nome_completo, u.nick, p.foto_perfil, p.ocupacao
    ORDER BY 
        seguido_por_amigos DESC,
        total_seguidores DESC,
        ultima_publicacao DESC,
        total_publicacoes DESC
    LIMIT 5
";

try {
    $stmt = $con->prepare($sqlSuggestions);
    $stmt->bind_param("iii", $currentUserId, $currentUserId, $currentUserId);
    $stmt->execute();
    $result = $stmt->get_result();
    
    $suggestions = [];
    while ($row = $result->fetch_assoc()) {
        $suggestions[] = [
            'id' => (int)$row['id'],
            'nome_completo' => $row['nome_completo'],
            'nick' => $row['nick'],
            'foto_perfil' => $row['foto_perfil'],
            'ocupacao' => $row['ocupacao'],
            'total_seguidores' => (int)$row['total_seguidores'],
            'total_publicacoes' => (int)$row['total_publicacoes'],
            'seguido_por_amigos' => (bool)$row['seguido_por_amigos']
        ];
    }
    
    echo json_encode([
        'success' => true,
        'suggestions' => $suggestions
    ]);
    
} catch (Exception $e) {
    echo json_encode([
        'success' => false,
        'message' => 'Erro ao carregar sugestões: ' . $e->getMessage()
    ]);
}
?>